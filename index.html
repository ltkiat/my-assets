<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI 视觉洞察 - 移动端 Web App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #000;
            height: 100%;
            width: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        /* 3D 翻转容器设置 */
        .scene {
            width: 100vw;
            height: 100vh;
            perspective: 2000px;
        }

        .card {
            width: 100%;
            height: 100%;
            position: relative;
            transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d;
        }

        .card.is-flipped {
            transform: rotateY(180deg);
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            overflow: hidden;
        }

        /* 确保背面在翻转后处于顶层 */
        .card-face-back {
            transform: rotateY(180deg);
            background: #050505;
            z-index: 1; /* 初始层级 */
        }

        /* 当父级翻转时，强制提升背面层级 */
        .card.is-flipped .card-face-back {
            z-index: 20;
        }

        /* 视频层样式 */
        .video-viewport {
            position: absolute;
            inset: 0;
            background: #000;
        }

        #bgVideo {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            filter: blur(40px) brightness(0.2);
            z-index: 1;
        }

        #mainVideo {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: contain; 
            z-index: 2;
        }

        /* 修改背景为流光渐变 */
        .gallery-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            /* 多色深色调渐变 */
            background: linear-gradient(135deg, #000000, #0a0a2e, #1a0a1a, #000000);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            overflow: hidden;
        }

        /* 背景流动动画 */
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* 给图片增加一个呼吸感的光晕 */
        .gallery-slide img {
            max-width: 90%;
            max-height: 85%;
            object-fit: contain;
            border-radius: 16px;
            /* 蓝色和紫色的微弱投影，模拟屏幕发光 */
            box-shadow: 0 0 50px rgba(66, 133, 244, 0.15), 0 30px 60px rgba(0,0,0,0.8);
            border: 1px solid rgba(255,255,255,0.1);
            transition: transform 0.8s ease;
            transition: transform 0.1s ease-out; /* 关键：让视角跟随更顺滑 */
            will-change: transform; /* 性能优化 */
        }

        /* 增加背景装饰：漂浮的虚化光点 */
        .orb {
            position: absolute;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(66, 133, 244, 0.1) 0%, rgba(0,0,0,0) 70%);
            border-radius: 50%;
            filter: blur(40px);
            z-index: 0;
            pointer-events: none;
            animation: float 20s infinite alternate;
        }

        @keyframes float {
            from { transform: translate(-50%, -50%); }
            to { transform: translate(50%, 50%); }
        }

        .gallery-slide {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 0.6s ease-in-out, transform 0.6s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: scale(0.95);
        }

        .gallery-slide.active {
            opacity: 1;
            transform: scale(1);
        }

        .gallery-slide img {
            max-width: 90%;
            max-height: 85%;
            object-fit: contain;
            border-radius: 16px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.8);
            border: 1px solid rgba(255,255,255,0.05);
        }

        /* UI 控件样式 */
        .glass-panel {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 28px;
        }

        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
            width: 100%;
        }

        input[type="range"]::-webkit-slider-runnable-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 999px;
            height: 54px;
            padding: 4px;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            height: 46px;
            width: 60px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        }

        .shimmer-text {
            background: linear-gradient(90deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.6) 50%, rgba(255,255,255,0.1) 100%);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shimmer 6s infinite linear;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* AI 面板动画 */
        .ai-response-panel {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
        }
        .ai-response-panel.open {
            max-height: 400px;
        }

        .btn-action {
            padding: 8px 16px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: rgba(255,255,255,0.5);
            transition: all 0.2s;
        }
        .btn-action:active { transform: scale(0.95); opacity: 0.8; }
        
    </style>
</head>
<body>

    <div class="scene">
        <div class="card" id="mainCard">
            <div class="card-face card-face-front">
                <div class="video-viewport">
                    <video id="bgVideo" crossorigin="anonymous" playsinline loop muted src="https://res.cloudinary.com/dhxdlendi/video/upload/v1769832515/copy_135D3F76-41C8-4D89-BAB7-DEAD6244B58A_ccnbst.mp4"></video>
                    <video id="mainVideo" crossorigin="anonymous" preload="auto" playsinline loop muted src="https://res.cloudinary.com/dhxdlendi/video/upload/v1769832515/copy_135D3F76-41C8-4D89-BAB7-DEAD6244B58A_ccnbst.mp4"></video>
                    <canvas id="captureCanvas" class="hidden"></canvas>
                    <div id="loadingIndicator" class="absolute inset-0 flex items-center justify-center bg-black/20 hidden z-40">
                        <div class="w-8 h-8 border-2 border-white/10 border-t-white/80 rounded-full animate-spin"></div>
                    </div>
                </div>

                <div class="fixed top-8 left-0 right-0 flex flex-col items-center gap-3 z-50 pointer-events-none">
                    <div id="timeOverlay" class="glass-panel px-4 py-1.5 text-white/40 font-mono text-[9px] tracking-[0.2em] opacity-0 transition-opacity">
                        00:00 / 00:00
                    </div>
                    
                    <div id="aiResultContainer" class="glass-panel w-[85%] max-w-sm p-4 pointer-events-auto ai-response-panel">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-[8px] font-bold text-blue-400/70 uppercase tracking-widest">Gemini Insight</span>
                            <button onclick="closeAIPanel()" class="text-white/20 text-xl">&times;</button>
                        </div>
                        <div id="aiTextContent" class="text-[11px] text-white/70 leading-relaxed italic"></div>
                    </div>
                </div>

                <div class="fixed bottom-10 left-1/2 -translate-x-1/2 w-[92%] max-w-sm z-50 glass-panel p-5 space-y-4">
                    <div class="flex justify-between px-2">
                        <button onclick="analyzeFrame()" class="btn-action">Analyze</button>
                        <button id="audioTrigger" onclick="enableAudio()" class="btn-action text-blue-400">Enable Sound</button>
                    </div>

                    <div class="relative h-[54px]">
                        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                            <span class="text-[10px] font-black tracking-[0.5em] uppercase shimmer-text">Slide to Explore</span>
                        </div>
                        <input type="range" id="videoScrubber" min="0" max="100" value="0" step="0.05">
                    </div>
                </div>
            </div>

            <div class="card-face card-face-back">
                
                <div class="orb" style="top: 20%; left: 20%;"></div>
                
                <div class="orb" style="top: 70%; left: 80%; background: radial-gradient(circle, rgba(161, 66, 244, 0.15) 0%, rgba(0,0,0,0) 70%); animation-delay: -5s;"></div>

                <div class="gallery-container" id="gallery"></div>

                <div class="absolute bottom-12 left-0 right-0 flex flex-col items-center gap-6 z-50">
                    <button onclick="flipBack()" class="glass-panel px-10 py-3 text-[11px] text-white font-black uppercase tracking-[0.4em] active:scale-95 transition-all">Return</button>
                    <div class="flex flex-col items-center">
                        <p id="galleryStatus" class="text-[10px] text-white/30 uppercase tracking-[0.2em]">Memories Syncing</p>
                        <div class="w-12 h-0.5 bg-white/10 mt-2 rounded-full overflow-hidden">
                            <div id="progressBar" class="h-full bg-white/40 transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <audio id="unlockAudio" preload="auto" loop>
        <source src="https://res.cloudinary.com/dhxdlendi/video/upload/v1769830994/ccba_qeo2l3.mp4" type="audio/mpeg">
    </audio>

<script>
    const mainCard = document.getElementById('mainCard');
    const mainVideo = document.getElementById('mainVideo');
    const bgVideo = document.getElementById('bgVideo');
    const scrubber = document.getElementById('videoScrubber');
    const timeOverlay = document.getElementById('timeOverlay');
    const aiResultContainer = document.getElementById('aiResultContainer');
    const aiTextContent = document.getElementById('aiTextContent');
    const captureCanvas = document.getElementById('captureCanvas');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const gallery = document.getElementById('gallery');
    const galleryStatus = document.getElementById('galleryStatus');
    const progressBar = document.getElementById('progressBar');
    const unlockAudio = document.getElementById('unlockAudio');

    const apiKey = ""; // 请填入你的 Gemini API Key
    let isDragging = false; // 新增：拖动状态锁
    let rAFId = null;
    let audioContextUnlocked = false;
    let isMusicPlaying = false; // 状态锁，防止声音重叠

    const images = [
        "https://i.postimg.cc/VNNc2X90/IMG_0695.jpg",
        "https://i.postimg.cc/Hx7FCzr2/IMG_4989.jpg",
        "https://i.postimg.cc/MTjg85nt/IMG_8038.jpg",
        "https://i.postimg.cc/j5JBrcDR/IMG_9355.jpg",
        "https://i.postimg.cc/wT94WgQ1/30731751_B7EC_40D9_8161_F37AAB644D6D_(2).png",
        "https://i.postimg.cc/MKtPNNs8/C701E72D_97D1_4C84_B91E_C57890825ECE.png",
        "https://i.postimg.cc/dtnHpp56/F75E3D58_F909_42AC_BE74_CBB8B9D1E3D4.png"
    ];

    // 1. 媒体授权逻辑 (点击 Enable Sound 时触发)
    function enableAudio() {
        const audioBtn = document.getElementById('audioTrigger');
        
        // 解锁背面背景音乐
        unlockAudio.muted = false;
        unlockAudio.play().then(() => {
            unlockAudio.pause();
            unlockAudio.currentTime = 0;
            audioContextUnlocked = true;
            
            audioBtn.innerText = "Sound ON ✓";
            audioBtn.style.opacity = "0.4";
            audioBtn.disabled = true;
        }).catch(e => console.error("Audio unlock failed:", e));

        // --- 关键修复：解锁前面视频的声音 ---
        mainVideo.muted = false;
        bgVideo.muted = false;
        
        // 瞬间播放再暂停，激活音频链路但不产生进度位移
        mainVideo.play().then(() => {
            mainVideo.pause(); 
        }).catch(()=>{});
    }

    // 2. 视觉识别逻辑
    async function analyzeFrame() {
        if (!apiKey) { alert("Please set Gemini API Key"); return; }
        loadingIndicator.classList.remove('hidden');
        const ctx = captureCanvas.getContext('2d');
        captureCanvas.width = mainVideo.videoWidth;
        captureCanvas.height = mainVideo.videoHeight;
        ctx.drawImage(mainVideo, 0, 0);
        const base64Image = captureCanvas.toDataURL('image/jpeg', 0.8).split(',')[1];
        const prompt = "以诗意且简短的语言（20字以内）描述画面中的情感 or 意境，直接输出描述。";
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: "image/jpeg", data: base64Image } }] }]
                })
            }).then(res => res.json());

            const text = response.candidates[0].content.parts[0].text;
            aiTextContent.innerText = text;
            aiResultContainer.classList.add('open');
        } catch (error) {
            aiTextContent.innerText = "Insight failed to sync.";
            aiResultContainer.classList.add('open');
        } finally {
            loadingIndicator.classList.add('hidden');
        }
    }

    function closeAIPanel() { aiResultContainer.classList.remove('open'); }

    // 3. 图集逻辑
    function initGallery() {
        gallery.innerHTML = '';
        images.forEach((src, index) => {
            const div = document.createElement('div');
            div.className = `gallery-slide ${index === 0 ? 'active' : ''}`;
            div.innerHTML = `<img src="${src}" alt="Memory ${index}">`;
            gallery.appendChild(div);
        });
    }

    function startGallery() {
        let currentSlide = 0;
        if (window.galleryInterval) clearInterval(window.galleryInterval);
        
        // 动态文字效果
        const statusTexts = ["Syncing Souls...", "Reading Memories...", "Echoes of Time...", "Beautiful Moments"];
        
        window.galleryInterval = setInterval(() => {
            const slides = document.querySelectorAll('.gallery-slide');
            if (!slides.length) return;
            
            slides[currentSlide].classList.remove('active');
            currentSlide = (currentSlide + 1) % slides.length;
            slides[currentSlide].classList.add('active');
            
            // 每次切换图片时随机换一句话
            galleryStatus.innerText = statusTexts[Math.floor(Math.random() * statusTexts.length)];
            
            progressBar.style.width = `${((currentSlide + 1) / slides.length) * 100}%`;
        }, 1800);
    }

    // 4. 进度条与翻转逻辑
    // 开始拖动
    scrubber.addEventListener('input', (e) => {
        isDragging = true; // 标记正在拖动
        if (!mainVideo.duration) return;
        updateSeek(mainVideo.duration * (e.target.value / 100));
    });

    // 停止拖动（松开手指/鼠标）
    const handleRelease = () => {
        isDragging = false; 
        const val = parseFloat(scrubber.value);
        
        if (val > 85) {
            triggerFlip();
        } else {
            // 松手后立即重置并暂停
            scrubber.value = 0;
            updateSeek(0);
            mainVideo.pause(); 
            bgVideo.pause();
        }
    };

    // --- 关键：必须添加下面这两行监听，否则松手时不会触发判断 ---
    scrubber.addEventListener('touchend', handleRelease);
    scrubber.addEventListener('mouseup', handleRelease);

    function triggerFlip() {
        // 1. 添加翻转类名
        mainCard.classList.add('is-flipped');
        
        // 2. 触觉反馈
        if (navigator.vibrate) navigator.vibrate(50);
        
        // 3. 立即停止当前视频声音
        mainVideo.pause();
        bgVideo.pause();

        // 4. 修改这里：延迟 1000 毫秒（1秒）后再播放背景音乐
        if (audioContextUnlocked && !isMusicPlaying) {
            isMusicPlaying = true;
            
            setTimeout(() => {
                // 确保翻转完成后再播放
                unlockAudio.currentTime = 0;
                unlockAudio.play().catch(e => {
                    console.log("Audio play deferred");
                    isMusicPlaying = false; // 播放失败重置状态
                });
            }, 1000); // 1000 毫秒 = 1 秒
        }
        
        // 5. 启动背面图集
        initGallery();
        setTimeout(startGallery, 600);
    }

    function flipBack() {
        mainCard.classList.remove('is-flipped');
        if (window.galleryInterval) clearInterval(window.galleryInterval);
        
        // 停止背景音乐
        unlockAudio.pause();
        unlockAudio.currentTime = 0;
        isMusicPlaying = false;

        scrubber.value = 0; 
        updateSeek(0);
        if (audioContextUnlocked) { 
            mainVideo.play().catch(()=>{}); 
            bgVideo.play().catch(()=>{}); 
        }
    }

    function updateSeek(targetTime) {
        if (rAFId) cancelAnimationFrame(rAFId);
        rAFId = requestAnimationFrame(() => {
            mainVideo.currentTime = targetTime;
            bgVideo.currentTime = targetTime;

            // --- 新增：手动滑动时开启声音 ---
            if (audioContextUnlocked) {
                // 确保视频取消静音
                mainVideo.muted = false;
                // 关键：只要在滑动，就让视频进入播放状态
                if (mainVideo.paused) {
                    mainVideo.play().catch(() => {});
                }
            }
        });
    }

    function formatTime(seconds) {
        const m = Math.floor(seconds / 60);
        const s = Math.floor(seconds % 60);
        return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    }

    mainVideo.addEventListener('loadedmetadata', () => {
        timeOverlay.classList.remove('opacity-0');
        timeOverlay.innerText = `00:00 / ${formatTime(mainVideo.duration)}`;
    });

    mainVideo.addEventListener('timeupdate', () => {
        // 只有在【没在拖动】且【视频正在走】时，才自动更新进度条
        if (!isDragging && !mainVideo.paused) {
            scrubber.value = (mainVideo.currentTime / mainVideo.duration) * 100;
            bgVideo.currentTime = mainVideo.currentTime;
            timeOverlay.innerText = `${formatTime(mainVideo.currentTime)} / ${formatTime(mainVideo.duration)}`;
        }
    });

    window.onload = initGallery;

    // 陀螺仪视差逻辑
    window.addEventListener('deviceorientation', (event) => {
        // 只有在翻转到背面且图集存在时才执行
        if (!mainCard.classList.contains('is-flipped')) return;

        const activeImg = document.querySelector('.gallery-slide.active img');
        if (!activeImg) return;

        // 获取手机倾斜角度 (beta: 前后, gamma: 左右)
        let tiltX = event.gamma; // 左右倾斜 (-90 到 90)
        let tiltY = event.beta;  // 前后倾斜 (-180 到 180)

        // 限制范围并计算位移 (数值越小移动越细腻)
        const moveX = Math.max(-15, Math.min(15, tiltX / 2)); 
        const moveY = Math.max(-15, Math.min(15, (tiltY - 45) / 2)); // 减45度是因为人握手机通常有倾角

        // 应用 3D 位移效果
        activeImg.style.transform = `translate3d(${moveX}px, ${moveY}px, 50px) rotateX(${-moveY/2}deg) rotateY(${moveX/2}deg)`;
    });

    // 注意：iOS 13+ 需要用户授权才能使用陀螺仪
    function requestMotionPermission() {
        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
            DeviceOrientationEvent.requestPermission()
                .then(permissionState => {
                    if (permissionState === 'granted') {
                        console.log("Motion access granted");
                    }
                })
                .catch(console.error);
        }
    }

    // 我们可以把这个授权挂在你的 "Enable Sound" 按钮上
    const originalEnableAudio = enableAudio;
    enableAudio = function() {
        originalEnableAudio();
        requestMotionPermission();
    };
</script>
</body>
</html>
